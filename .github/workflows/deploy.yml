name: Deploy to GitHub Pages

on:
  push:
    branches: [ '**' ]  # Build all branches for feedback
  pull_request:
    branches: [ main, experimenting ]
  workflow_dispatch:  # Allow manual trigger

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest

    # Required permissions for GitHub Pages deployment
    permissions:
      contents: write      # For gh-pages branch deployment
      pages: write         # For GitHub Pages
      id-token: write      # For OIDC token

    # Concurrency group to prevent multiple deployments
    concurrency:
      group: "pages"
      cancel-in-progress: false

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # Fetch all history for better diagnostics

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'  # Use Node 20 (LTS)
        cache: 'npm'

    - name: Install Dependencies
      run: |
        echo "ğŸ“¦ Installing dependencies..."
        npm ci
        echo "âœ… Dependencies installed"

    - name: Build Application
      run: |
        echo "ğŸ”¨ Building application..."
        npm run build:client
        echo "âœ… Build completed"
      env:
        NODE_ENV: production
        VITE_BASE_PATH: "/${{ github.event.repository.name }}/"

    - name: Validate Build Output
      run: |
        echo "ğŸ” Validating build output..."

        # Check dist directory exists
        if [ ! -d "./dist" ]; then
          echo "âŒ Error: ./dist directory not found!"
          exit 1
        fi

        # Check index.html exists
        if [ ! -f "./dist/index.html" ]; then
          echo "âŒ Error: ./dist/index.html not found!"
          exit 1
        fi

        # Check assets directory exists
        if [ ! -d "./dist/assets" ]; then
          echo "âŒ Error: ./dist/assets directory not found!"
          exit 1
        fi

        # Verify critical files
        echo "ğŸ“‹ Critical files check:"
        for file in index.html 404.html .nojekyll manifest.json; do
          if [ -f "./dist/$file" ]; then
            echo "  âœ… $file"
          else
            echo "  âš ï¸  Missing: $file"
          fi
        done

        echo ""
        echo "ğŸ“¦ Build directory contents:"
        ls -lah ./dist
        echo ""
        echo "ğŸ“¦ Assets directory:"
        ls -lah ./dist/assets | head -20
        echo ""
        echo "ğŸ” Checking asset paths in index.html:"
        grep -E '(href=|src=)' ./dist/index.html | head -5
        echo ""
        echo "âœ… Build validation completed"

    - name: Check GitHub Pages Configuration
      id: pages-check
      continue-on-error: true
      run: |
        echo "ğŸ” Checking GitHub Pages configuration..."

        PAGES_INFO=$(curl -s -H "Accept: application/vnd.github+json" \
          -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
          "https://api.github.com/repos/${{ github.repository }}/pages")

        echo "ğŸ“„ Pages API Response:"
        echo "$PAGES_INFO" | jq '.' || echo "$PAGES_INFO"

        PAGES_STATUS=$(echo "$PAGES_INFO" | jq -r '.status // "not_configured"')
        PAGES_URL=$(echo "$PAGES_INFO" | jq -r '.html_url // ""')

        echo "pages_status=${PAGES_STATUS}" >> $GITHUB_OUTPUT
        echo "pages_url=${PAGES_URL}" >> $GITHUB_OUTPUT

        if [ "$PAGES_STATUS" == "not_configured" ] || [ "$PAGES_STATUS" == "null" ]; then
          echo ""
          echo "âš ï¸  WARNING: GitHub Pages is not properly configured!"
          echo ""
          echo "ğŸ“– Setup Instructions:"
          echo "   1. Go to: https://github.com/${{ github.repository }}/settings/pages"
          echo "   2. Under 'Build and deployment':"
          echo "      - Set Source to 'Deploy from a branch'"
          echo "      - Select branch: 'gh-pages'"
          echo "      - Select folder: '/ (root)'"
          echo "   3. Click 'Save'"
          echo "   4. Wait 1-2 minutes for deployment"
          echo ""
          echo "ğŸŒ Expected URL: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
        else
          echo "âœ… GitHub Pages is configured"
          echo "ğŸ“Š Status: ${PAGES_STATUS}"
          if [ -n "$PAGES_URL" ]; then
            echo "ğŸŒ URL: ${PAGES_URL}"
          fi
        fi

    - name: Deployment Decision
      id: should-deploy
      run: |
        SHOULD_DEPLOY="false"

        if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
          SHOULD_DEPLOY="true"
          echo "âœ… Manual deployment triggered"
        elif [[ "${{ github.event_name }}" == "push" ]]; then
          if [[ "${{ github.ref }}" == "refs/heads/main" ]]; then
            SHOULD_DEPLOY="true"
            echo "âœ… Deploying from main branch"
          elif [[ "${{ github.ref }}" == "refs/heads/experimenting" ]]; then
            SHOULD_DEPLOY="true"
            echo "âœ… Deploying from experimenting branch"
          else
            echo "â„¹ï¸  Build successful, but not deploying from ${{ github.ref_name }}"
            echo "ğŸ“ Only main and experimenting branches trigger deployment"
          fi
        else
          echo "â„¹ï¸  Event type: ${{ github.event_name }}"
          echo "ğŸ“ Not deploying for this event type"
        fi

        echo "should_deploy=${SHOULD_DEPLOY}" >> $GITHUB_OUTPUT

    - name: Deploy to GitHub Pages
      if: steps.should-deploy.outputs.should_deploy == 'true'
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./dist
        publish_branch: gh-pages
        force_orphan: true  # Keep gh-pages clean
        user_name: 'github-actions[bot]'
        user_email: 'github-actions[bot]@users.noreply.github.com'
        commit_message: |
          Deploy from ${{ github.ref_name }}

          Source commit: ${{ github.sha }}
          Workflow run: ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}

    - name: Deployment Summary
      if: always()
      run: |
        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo "                    ğŸ“Š DEPLOYMENT SUMMARY"
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""
        echo "ğŸ”¨ Build Status: ${{ job.status }}"
        echo "ğŸ“¦ Branch: ${{ github.ref_name }}"
        echo "ğŸ“ Commit: ${{ github.sha }}"
        echo "ğŸ¯ Event: ${{ github.event_name }}"
        echo ""

        if [[ "${{ steps.should-deploy.outputs.should_deploy }}" == "true" ]]; then
          echo "ğŸš€ Deployment: TRIGGERED"
          echo ""

          PAGES_URL="${{ steps.pages-check.outputs.pages_url }}"
          if [ -z "$PAGES_URL" ]; then
            PAGES_URL="https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
          fi

          echo "ğŸŒ Site URL: ${PAGES_URL}"
          echo ""
          echo "â±ï¸  Deployment Timeline:"
          echo "   1. Pushing to gh-pages branch... âœ…"
          echo "   2. GitHub processing... (1-2 minutes)"
          echo "   3. Site live at URL above"
          echo ""

          if [ "${{ steps.pages-check.outputs.pages_status }}" == "not_configured" ]; then
            echo "âš ï¸  IMPORTANT: Enable GitHub Pages in repository settings!"
            echo "   Settings: https://github.com/${{ github.repository }}/settings/pages"
            echo "   Configure: Deploy from 'gh-pages' branch, '/' folder"
          else
            echo "âœ… GitHub Pages is configured correctly"
          fi
        else
          echo "â­ï¸  Deployment: SKIPPED"
          echo "   Only main/experimenting branches trigger deployment"
        fi

        echo ""
        echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
        echo ""

    - name: Comment on PR
      if: github.event_name == 'pull_request' && steps.should-deploy.outputs.should_deploy == 'false'
      uses: actions/github-script@v7
      continue-on-error: true
      with:
        script: |
          github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: 'âœ… **Build successful!** This PR builds correctly but won\'t be deployed until merged to `main` or `experimenting`.'
          })
